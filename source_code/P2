from __future__ import print_function
from gurobipy import *
import pandas as pd
import numpy as np

"""Define the data to be used"""
class Data:
    demand_point_num = 0
    demand_type = 0
    vehicle_num = 0
    capacity = 0
    inventory = []
  """"............"""

    M = 0
    
    
"""Read data of each instance CX"""
def readData(data):
    demand = pd.read_excel(r'cedelocation\demandnode_CX.xlsx',header=None)
    demandnode = demand.values
    print(demandnode)
    data.demand = demandnode
    data.demand_point_num = demandnode.shape[1]
    demand_LB = pd.read_excel(r'cedelocation\demand_LB_CX.xlsx')
    np.save("demand_LB_CX",demand_LB)
    data.demand_LB = np.load(r'cedelocation\demand_LB_CX.npy')


    data.demand_UB = np.load(r'cedelocation\demand_UB_CX.npy')

    demand_average = pd.read_excel(r'cedelocation\demand_average_CX.xlsx')
    np.save("demand_average_CX",demand_average)
    data.demand_average = np.load(r'cedelocation\demand_average_CX.npy')


 """"....................."""


data = Data()
readData(data)

model = Model("P2")

"""Define variables based on the model, and write the objective function and constraints."""

y = model.addVars(data.vehicle_num, data.demand_point_num, vtype=GRB.BINARY, name="y")
z = model.addVars(data.vehicle_num, data.demand_point_num, data.demand_type, vtype=GRB.CONTINUOUS, name="z")
x = model.addVars(data.vehicle_num, vtype=GRB.BINARY,name="x")


"""dual variables"""

dual_yita = model.addVar(vtype=GRB.CONTINUOUS, name="dual_yita")
dual_aerfa1 = model.addVars(data.demand_point_num, data.demand_type, vtype=GRB.CONTINUOUS,name="dual_aerfa1")
dual_aerfa2 =model.addVars(data.demand_point_num, data.demand_type, vtype=GRB.CONTINUOUS,name="dual_aerfa2")
dual_beita1 = model.addVars(data.demand_point_num, data.demand_type, vtype=GRB.CONTINUOUS,name="dual_beita1")
"""".................."""


"""In accordance with the journal's data and code sharing policy, we provide the core implementation of the proposed algorithm. 
Due to proprietary technology limitations, some parts have been omitted."""
model.update()

model.setObjective(quicksum(dual_aerfa1[k,m] * data.demand_average_UB[k][m]- dual_aerfa2[k,m] * data.demand_average_LB[k][m] + dual_beita1[k,m] * data.demand_MAD[k][m] +
                            dual_beita2[k,m] * data.demand_MAD[k][m] for k in range(data.demand_point_num) for m in range(data.demand_type)) + dual_yita)

#
for k in range(data.demand_point_num):
    model.addConstr(quicksum(y[h,k] for h in range(data.vehicle_num)) == 1)

for h in range(data.vehicle_num):
    for k in range(data.demand_point_num):
        model.addConstr(y[h,k] <= data.M * x[h])


for h in range(data.vehicle_num):
    for k in range(data.demand_point_num):
        for m in range(data.demand_type):
            model.addConstr(z[h,k,m] <= data.M * y[h,k])


for h in range(data.vehicle_num):
    for k in range(data.demand_point_num):
        for m in range(data.demand_type):
            model.addConstr(fai[h,k,m] <= data.M * y[h,k])

for h in range(data.vehicle_num):
    for k in range(data.demand_point_num):
        for m in range(data.demand_type):
            model.addConstr(fai[h, k, m] <= z[h, k, m], "4-2")

for h in range(data.vehicle_num):
    for k in range(data.demand_point_num):
        for m in range(data.demand_type):
            model.addConstr(fai[h,k,m] >= z[h,k,m] - data.M * (1- y[h,k]))

for m in range(data.demand_type):
    model.addConstr(quicksum(fai[h,k,m] for h in range(data.vehicle_num) for k in range(data.demand_point_num)) <= data.inventory[m])



"""...................."""

model.Params.OutputFlag = 1
model.Params.LogFile = "log_file_P2.txt"
model.optimize()



model.printAttr('X')
print("objective value:", model.getAttr("ObjVal"))
